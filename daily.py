import random
import logging
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo
from telegram.ext import ContextTypes
from telegram import Update

from config import UNCHECK_CHANNEL_ID, TIMEZONE, DAILY_MORNING, DAILY_EVENING
from state import save_state

log = logging.getLogger("daily")

# Шаблоны — остроумно, без унижений и без призывов к вреду
MORNING_TEMPLATES = [
    "Доброе утро, Северная столица! Утренний кофе как init-процесс — запускает весь стек бодрости, роутер даёт сигнал, батарея полная; подключайся к дню, пингуй цели и не давай лагам шанса — по-понятиям, по-делу, без базара.",
    "Утро, Купчина: кофе уже в руке — стартовый скрипт выполнен, hotspot бодрости раздаёт ресурс на весь район, Wi-Fi ловит, и душа аптаймится. Держи канал чистым, не ссы и апдейти делай на горячую — сегодня работаем как сервер под нагрузкой.",
    "Просыпайся, братва Северная столица! Ранний пинг к мечтам положительный, CPU мысли переключён в турбо, кофе-daemon в фоне держит энергию. Оптимизируй утро: убирай фоновые процессы и скейлишь только важное — район похвалит за результат.",
    "Здарова, Северная столица! Утро — это наш протокол: SYN к кофе, ACK к действию. Роутер держит 5 полос для твоей энергии, latency минимален — делай всё жёстко, по-понятиям, и не включай бесконечный режим оправданий.",
    "Доброе утро, Северная столица! На зарядке зарядился телефон, зарядился ты — кофе как power-up, Wi-Fi как дорога до цели. Запускай задачи, веди мониторинг прогресса и не давай багам портить аптайм — мы тут пашем и побеждаем.",
    "Утро, Купчина: cron запускает план, кофе в очереди с высоким приоритетом, роутер стабилен — подключайся к делу и держи throughput на максимум. Если кто-то мешает — ставь low priority и делай своё, по-техничному и по-понятиям.",
    "Эй, Северная столица! Утренний reboot дал тебе свежую сессию: кеш эмоций очищен, кофе — как системный логин, Wi-Fi раздаёт уверенность. Иди и пушь свои задачи, не тормози на мелочах — район любит тех, кто делает.",
    "Подъём, Северная столица! Утренний стек инициализирован: кофе_daemon поднят, watchdog мотивации следит, роутер держит связь. Пинги к целям короткие — бери дело в руки и делай так, чтоб все смотрели с уважением и без базара.",
    "Доброе утро, Северная столица! Hotspot бодрости активирован, зарядка души включена, ноут и телефон на зарядке — оптимизируй рабочий поток, минимизируй latency в решениях и не ной: результат — твой лучший ответ на любые вопросы.",
    "Просыпайся, братва: утренний Wi-Fi подаёт сигнал, кофе грейдится до максимума, и твоя продуктивность начинает аптайм. Расставь приоритеты в QoS — сначала цели, потом треп; делай по-понятиям и забирай своё.",
    "Здарова, Северная столица! Утро как апдейт: патчим сон, деплоим бодрость, роутер держит коннект к возможностям. Запускай миграцию смысла в дела, не давай лагам съесть твою мотивацию — действуй чётко и по-сути.",
    "Утро, Купчина: батарейка души заряжена, кофе в руке — стартовый пакет получен. Trace route до успеха короткий — иди по прямой, не теряйся в переписках и настройках, держи канал продуктивности открытым 24/7.",
    "Доброе утро, Северная столица! Установи режим 'продуктивность': выключи лишние нотификации, включи coffee_mode, держи соединение с реальностью через стабильный Wi-Fi и работай как сервер на высокой нагрузке — без сбоев и без базара.",
    "Подъём, Северная столица! Утренний лог-файл заполнен планами — анализируй, устраняй баги и пушь фичи жизни. Кофе поддерживает энергию, роутер — связь с возможностями; если кто мешает — просто drop и дальше по-понятиям.",
    "Эй, Купчина! Утро — это твой аптайм, не давай меланхолии делать rollback. Кофе в руке, Wi-Fi в зоне, голова в турбо — оптимизируй расписание, включай глубинную работу и не парься из-за тех, кто не тянет план.",
    "Доброе утро, Северная столица! Запускаем утренний pipeline: кофе — источник, зарядка — ресурс, Wi-Fi — канал доставки. Прогоняй задачи по пайплайну, фиксируй успехи в логах и пусть район знает, кто сегодня держит темп.",
    "Просыпайся, братва Северная столица: утренний монитор показывает зелёный статус — бодрость онлайн, роутер даёт полосу, кофе греет. Убери все ненужные процессы и держи фокус — сегодня мы делаем то, что другие только обсуждают."
]

EVENING_TEMPLATES = [
    "Купчино, итоги дня: аптайм твоей воли держался весь день, логи в зелёном — ты молодец, выключай дела и восстанавливай батарейки, красавчик.",
    "Купчино, ты весь день как надёжный сервер — держал нагрузку, пинги к целям были короткие. Засыпай спокойно, ты молодец.",
    "Купчино, финальный чек: деплой прошёл, баги помечены, watchdog одобрил — отдыхай и набирай силы, красавчик.",
    "Купчино, сегодня ты держал сигнал — Wi-Fi бодрости не падал. Сохрани прогресс, отключайся и спи как босс, ты молодец.",
    "Купчино, лог дня показывает: результат +100. Отключай порты забот, патч усталости завтра — засни с чувством выполненного.",
    "Купчино, режим 'сон' активирован: закрой вкладки, включи 'не мешать' и восстанавливайся — ты молодец, район гордится.",
    "Купчино, throughput по делам впечатлил — коммиты сделаны, задачи в проде. Выключай экран и отдыхай, красавчик.",
    "Купчино, твой cron отработал отлично: задачи закрыты, энергия исцелится ночью. Спи крепко, ты молодец.",
    "Купчино, сегодня ты — стабильный кластер: выдержал нагрузку и не упал. Засыпай с улыбкой, красавчик.",
    "Купчино, итоги ясны: пинги к мечтам положительные, лаги минимальные. Отдыхай, завтра снова побеждаем, ты молодец.",
    "Купчага, день закрыт по-понятиям: логи чисты, патчи применены — отключайся и отдыхай, красавчик, ты молодец.",
    "Купчага, ты весь день как роутер — раздавал энергию и не падал. Сохрани прогресс и спи спокойно, ты молодец.",
    "Купчага, финальный апдейт: баги зафиксированы, KPI в плюсе. Выключай рабочий поток и набирайся сил, красавчик.",
    "Купчага, watchdog отдых разрешил — пора перезагрузиться. Кофе подождёт, сон важнее, ты молодец.",
    "Купчага, твой аптайм был стабилен: держал темп и штурмовал цели. Отбой для задач — включай сон, красавчик.",
    "Купчага, лог-файл дня полон побед — зафиксируй и выключайся. Ночной патч восстановит ресурсы, ты молодец.",
    "Купчага, trace route показал короткий путь к успеху — дошёл до цели. Спи спокойно, завтра новые рейды, красавчик.",
    "Купчага, коммит дня выполнен: результат в проде, уважение начислено. Отключай нотификации и отдыхай, ты молодец.",
    "Купчага, latency твоей выдержки был минимален — не подвёл команду. Перезагружайся, завтра снова в деле, красавчик.",
    "Купчага, итог: задачи закрыты, батареи подзарядятся ночью. Засыпай с гордостью — ты молодец.",
    "Санкт-Петербург, итоги дня: аптайм в Северной провинции держался, цели достигнуты — выключайте рабочий режим и отдыхайте, вы молодцы.",
    "Санкт-Петербург, вы весь день как надёжный кластер — нагрузку вынесли, логи чистые. Перезагружайтесь и спите крепко, красавчики.",
    "Санкт-Петербург, финальный чек: деплой успешен, баг-репорты минимальны. Отбой для задач — включаем сон, вы молодцы.",
    "Санкт-Петербург, вы держали связь и не теряли пакет — throughput высокий. Сохраняйте прогресс и восстанавливайтесь, красавчики.",
    "Санкт-Петербург, лог дня положительный: KPI в зелёном. Отключите порты забот и дайте себе отдых, вы молодцы.",
    "Санкт-Петербург, watchdog дал добро: ночной цикл — время восстановления. Выделите время на сон — вы красавчики.",
    "Санкт-Петербург, trace route до успеха короткий: вы дошли. Положите устройство и отдыхайте, вы молодцы.",
    "Санкт-Петербург, ваш cron выполнил все таски — коммиты в мастер. Засыпайте с чувством выполненного долга, красавчики.",
    "Санкт-Петербург, сегодня вы работали по-сути: стабильный аптайм и минимальные лаги. Отдыхайте, завтра новые релизы, вы молодцы.",
    "Санкт-Петербург, итог дня: прогресс сохранён, патчи усталости запланированы на ночь. Спокойной и крепкой ночи, красавчики.",
    "Северная столица, итоги: ваш аптайм сегодня был эталонным — выключайте задачи и восстанавливайте батареи, вы молодцы.",
    "Северная столица, вы весь день как сервер без падений — логи чистые, нагрузка вынесена. Засыпайте с удовольствием, красавцы.",
    "Северная столица, финальная сводка: деплой успеха готов, баги в backlog. Отключайтесь от сети и отдыхайте, вы молодцы.",
    "Северная столица, throughput по делам — на высоте. Закрывайте вкладки и давайте себе восстановление, красавцы.",
    "Северная столица, лог-файл дня наполнен достижениями. Патч усталости включим ночью — отдыхайте, вы молодцы.",
    "Северная столица, watchdog отдых разрешил: заряжайте батареи, завтра снова в игре. Засыпайте с гордостью, красавцы.",
    "Северная столица, trace route показал прямую дорогу к результату — вы дошли. Отключайтесь и спите крепко, вы молодцы.",
    "Северная столица, коммит дня принят: прогресс закреплён. Выключайте нотификации и отдыхайте, красавцы.",
    "Северная столица, сегодня вы держали марку — latency низкий, энергия отдана делу. Перезагружайтесь и возвращайтесь сильнее, вы молодцы.",
    "Северная столица, итог дня: все процессы завершены успешно — отдыхайте, набирайтесь сил и помните: вы молодцы."
]


# простейшая фильтрация, чтобы не сохранить заведомо токсичный/опасный текст
BANNED = []

def _safe_ok(text: str) -> bool:
    lo = (text or "").lower()
    return not any(bad in lo for bad in BANNED)

def _parse_hhmm(s: str):
    hh, mm = s.split(":")
    return int(hh), int(mm)

def _seconds_until_next(hh: int, mm: int, tz: str):
    z = ZoneInfo(tz)
    now = datetime.now(z)
    target = now.replace(hour=hh, minute=mm, second=0, microsecond=0)
    if target <= now:
        target += timedelta(days=1)
    return (target - now).total_seconds()

async def morning_job(context: ContextTypes.DEFAULT_TYPE):
    state = context.application.bot_data["state"]
    d = state.setdefault("daily", {})
    pool = d.get("morning_pool") or MORNING_TEMPLATES
    msg = random.choice(pool)
    try:
        await context.bot.send_message(chat_id=UNCHECK_CHANNEL_ID, text=msg)
    except Exception:
        log.exception("morning_job send fail")

async def evening_job(context: ContextTypes.DEFAULT_TYPE):
    state = context.application.bot_data["state"]
    d = state.setdefault("daily", {})
    pool = d.get("evening_pool") or EVENING_TEMPLATES
    msg = random.choice(pool)
    try:
        await context.bot.send_message(chat_id=UNCHECK_CHANNEL_ID, text=msg)
    except Exception:
        log.exception("evening_job send fail")

def schedule_daily(scheduler, tz: str, morning_hhmm: str, evening_hhmm: str):
    mh, mm = _parse_hhmm(morning_hhmm)
    eh, em = _parse_hhmm(evening_hhmm)
    scheduler.run_once(morning_job, when=_seconds_until_next(mh, mm, tz))
    scheduler.run_repeating(morning_job, interval=86400, first=_seconds_until_next(mh, mm, tz))
    scheduler.run_once(evening_job, when=_seconds_until_next(eh, em, tz))
    scheduler.run_repeating(evening_job, interval=86400, first=_seconds_until_next(eh, em, tz))

# ===== Команды для модчата =====
async def cmd_daily_on(update: Update, context: ContextTypes.DEFAULT_TYPE):
    state = context.application.bot_data["state"]
    d = state.setdefault("daily", {})
    d["enabled"] = True
    save_state(state)
    await update.message.reply_text("Ежедневные сообщения: включены.")

async def cmd_daily_off(update: Update, context: ContextTypes.DEFAULT_TYPE):
    state = context.application.bot_data["state"]
    d = state.setdefault("daily", {})
    d["enabled"] = False
    save_state(state)
    await update.message.reply_text("Ежедневные сообщения: выключены.")

async def cmd_daily_status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    state = context.application.bot_data["state"]
    d = state.setdefault("daily", {})
    en = d.get("enabled", False)
    await update.message.reply_text(f"Статус: {'включены' if en else 'выключены'}. Время: утро {DAILY_MORNING}, вечер {DAILY_EVENING} (MSK).")

async def cmd_daily_set(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    /daily_set morning <текст>
    /daily_set evening <текст>
    """
    state = context.application.bot_data["state"]
    if len(context.args) < 2:
        await update.message.reply_text("Формат: /daily_set morning|evening <текст>")
        return
    kind = context.args[0].lower()
    text = " ".join(context.args[1:]).strip()
    if not _safe_ok(text):
        await update.message.reply_text("Не могу сохранить такой текст. Давайте без токсичности и призывов к вреду.")
        return
    d = state.setdefault("daily", {})
    key = "morning_pool" if kind == "morning" else "evening_pool" if kind == "evening" else None
    if not key:
        await update.message.reply_text("Первый аргумент должен быть morning или evening.")
        return
    # позволяем накапливать варианты
    pool = d.get(key) or (MORNING_TEMPLATES if key == "morning_pool" else EVENING_TEMPLATES)
    pool = list(pool) + [text]
    d[key] = pool
    save_state(state)
    await update.message.reply_text("Шаблон добавлен.")